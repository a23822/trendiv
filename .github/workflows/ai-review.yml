name: AI Reviewer

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

# 중복 실행 방지 (새 커밋이 오면 이전 AI 리뷰는 취소)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ai-review:
    runs-on: ubuntu-latest
    # ui-generate 라벨 있으면 스킵
    if: |
      !contains(github.event.pull_request.labels.*.name, 'ui-generate') && 
      contains(github.event.pull_request.labels.*.name, 'review')
    permissions:
      contents: read
      pull-requests: write

    steps:
      # 커밋 메시지 체크 (AI 생성 커밋이면 스킵)
      - name: Check Skip Condition
        id: skip-check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message || github.event.pull_request.title }}"
          if [[ "$COMMIT_MSG" == *"[skip review]"* ]] || [[ "$COMMIT_MSG" == *"AI Generated"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "⏭️ AI 리뷰 스킵: $COMMIT_MSG"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.skip-check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. pnpm 설치
      - name: Install pnpm
        if: steps.skip-check.outputs.skip != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Node.js
        if: steps.skip-check.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      # 2. 의존성 설치
      # 모노레포 루트에서 개발 의존성 설치 (-w)
      - name: Install Dependencies
        if: steps.skip-check.outputs.skip != 'true'
        run: pnpm install

      # 3. 변경된 파일 목록 추출
      - name: Get Changed Files
        if: steps.skip-check.outputs.skip != 'true'
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          separator: " "

      # 4. AI 스크립트 실행
      - name: Run AI Reviewer Script
        if: steps.skip-check.outputs.skip != 'true' && steps.changed-files.outputs.any_changed == 'true'
        env:
          AI_REVIEW_CONCURRENCY: "3"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL_LIGHT: ${{ vars.GEMINI_MODEL_LIGHT || 'gemini-3-flash-preview' }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          AI_REVIEW_RULES_PATH: .github/ai-review-rules.md
        run: npx tsx scripts/ai-reviewer.ts ${{ steps.changed-files.outputs.all_changed_files }}
