name: AI Chat Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:

concurrency:
  group: ai-chat-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.comment.id }}

jobs:
  ai-chat:
    if: |
      github.event.comment.performed_via_github_app == null &&
      github.event.comment.user.type != 'Bot' &&
      !contains(github.event.comment.user.login, '[bot]') &&
      contains(github.event.comment.body, '@trendiv-chat') &&
      (
        (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
        github.event_name == 'pull_request_review_comment'
      )

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Bot Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install

      - name: Run AI Chat Script
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL_LIGHT: ${{ vars.GEMINI_MODEL_LIGHT || 'gemini-3-flash-preview' }}
          PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_ID: ${{ github.event.comment.id }}
          USER_LOGIN: ${{ github.event.comment.user.login }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          DIFF_HUNK: ${{ github.event.comment.diff_hunk || '' }}
          FILE_PATH: ${{ github.event.comment.path || '' }}
          LINE_NUMBER: ${{ github.event.comment.line || github.event.comment.original_line || '' }}
        run: npx tsx scripts/ai-chat.ts
